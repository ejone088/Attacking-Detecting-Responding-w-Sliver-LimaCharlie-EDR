# Attacking, Detecting and Responding w/Sliver & LimaCharlie (EDR)
The following project replicates detecting malicious activity from Sliver (open-source alternative to Cobalt Strike) and responding to it using LimaCharlie.

Source (Eric Capuano's Guide): https://blog.ecapuano.com/p/so-you-want-to-be-a-soc-analyst-part

# Windows 11 VM Setup
Disabled Windows Security features and Microsoft Defender using Windows Registry for testing purposes

<img width="400" alt="image" src="https://github.com/user-attachments/assets/be1afba1-5a2f-40e0-b980-71e5acf349eb">

<img width="487" alt="image" src="https://github.com/user-attachments/assets/f8f2f75b-a34f-4e9d-a7f8-57a79f47cfac">

Downloading and installing Sysmon

<img width="479" alt="image" src="https://github.com/user-attachments/assets/d4bcd2dd-240f-4616-bb4b-93e5c44c4673">

Confirmed Sysmon is up and running then checked for logs

<img width="480" alt="image" src="https://github.com/user-attachments/assets/f93bd988-14c0-4e30-bb08-94ec372110f0">


Successfully installed a sensor (EDR agent) from LimaCharlie

<img width="477" alt="image" src="https://github.com/user-attachments/assets/82260ee0-9dd8-41bf-aa4f-1e99ef234461">

Created an Artifact Collection Rule that has LimaCharlie collecting Sysmon logs

<img width="447" alt="image" src="https://github.com/user-attachments/assets/a6530068-1f3e-4416-8464-43e96581ac25">

# Linux VM Server Setup
Installed Sliver for C2 functionality

<img width="599" alt="image" src="https://github.com/user-attachments/assets/5b203e95-9c62-44aa-8080-f2e07f623e5c">

Generated a C2 payload to later be dropped on the Windows VM and confirmed the payload is ready to go

<img width="435" alt="image" src="https://github.com/user-attachments/assets/663b8c2c-9f67-4436-a435-4d973ceac3b6">

Set up a Python server to download the payload from the Linux VM to the Windows VM

<img width="334" alt="image" src="https://github.com/user-attachments/assets/651cb84d-b197-446f-b060-b6505b7743b7">

# Installing Malware & Starting A C2 Session

Dropped the payload on the Windows VM

<img width="484" alt="image" src="https://github.com/user-attachments/assets/2a0dc87e-6a7b-402e-8dec-1cfeebb31293">

Started an HTTP listener, since the payload was generated with HTTP, to know when the payload is executed then executed the malware on the Windows VM and a session was generated on the Linux VM as a result

<img width="458" alt="image" src="https://github.com/user-attachments/assets/91fb82bb-2245-4f56-9d37-e775efabe315">

Began a session using the session ID, got the list of privileges and saw a few privileges that appeared to have come with the malware

<img width="670" alt="image" src="https://github.com/user-attachments/assets/fb24acb7-c40c-4f57-b9c7-d1c5c5f42dc8">

When looking at the processes on the target machine, Sliver highlights the process it's running in green and any possible defensive tools running in red

<img width="286" alt="image" src="https://github.com/user-attachments/assets/df3f643e-acc5-4f1d-864c-530914252b28">

# Investigating The Malware In LimaCharlie
In the LimaCharlie UI, it can be seen that the process representing the malware is NOT signed and it is active on the network

<img width="806" alt="image" src="https://github.com/user-attachments/assets/834cdc65-4d55-47f6-9977-9b0f10dd91a4">

Network Connections for the process; the destination is the Linux VM on port 80

<img width="915" alt="image" src="https://github.com/user-attachments/assets/573741a0-3c66-4b0c-8c6b-20fa0e947fa6">

Found further traces of the process on the Network & File System pages

<img width="805" alt="image" src="https://github.com/user-attachments/assets/7af99e94-319f-434e-ab76-979f8ce87fcd">
<img width="817" alt="image" src="https://github.com/user-attachments/assets/be939418-040e-4e02-94f4-a2c9ada6d24a">

Searching for the executable file's hash on VirusTotal but found no results (this does not mean the process is safe)

<img width="804" alt="image" src="https://github.com/user-attachments/assets/559d1b36-32a9-4ade-9626-ecb2418bb69f">

# Attacking w/Sliver & Detecting w/LimaCharlie EDR
Conducted an LSASS credential dump to generate malicious activity

<img width="280" alt="image" src="https://github.com/user-attachments/assets/1498cd68-027e-4b46-9359-30ecf76549fa">

Found the event generated by the credential dump and created a detection & response rule in LimaCharlie to detect future occurrences of the same type of event where the process of the Windows VM ends in lsass.exe and respond by creating a report

<img width="853" alt="image" src="https://github.com/user-attachments/assets/a35f244c-b916-4a00-94c2-738c98fc814f">
<img width="559" alt="image" src="https://github.com/user-attachments/assets/086ae270-3329-4088-923c-a7c0ba5465cd">

Ran the same credential dump but it was detected by the detection signature previously created in LimaCharlie

<img width="779" alt="image" src="https://github.com/user-attachments/assets/97fa9bf1-12b2-4b9d-b7a1-5224f57b0d16">

# Detecting Shadow Copy Deletion & Blocking It w/LimaCharlie EDR
Ran a command to delete shadow copies on the Windows VM and LimaCharlie picked up on it

<img width="843" alt="image" src="https://github.com/user-attachments/assets/ff2211fb-e08c-435c-9555-7c150df84e69">

Created a rule to block future deletion of shadow copies using LimaCharlie's "Build D&R Rule" option

<img width="559" alt="image" src="https://github.com/user-attachments/assets/ed87bbe1-f9cb-443c-89a5-df05d2d1cf00">

The red box signifies the deletion of shadow copies before the creation of the rule in LimaCharlie; the green box indicates an attempted deletion of the files that was blocked as there is no result returned for the whoami command because the parent process was eliminated due to the VSS Deletion rule created in LimaCharlie

<img width="314" alt="image" src="https://github.com/user-attachments/assets/df3764fd-2b5f-4d6a-ab1d-4d82db7c88e6">


